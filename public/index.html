<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gyancho</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Gyancho</h1>
    <p>Your algorithm-based study partner finder</p>
  </header>

  <!-- Login Screen -->
  <div id="loginScreen">
    <form id="loginForm">
      <h2>Welcome to Gyancho</h2>
      <input type="text" id="username" placeholder="Enter your name" required>
      <input type="text" id="subject" placeholder="Currently Studying Subject">
      <select id="studyPreference">
        <option value="teach">Teach a Dumber Student</option>
        <option value="learn">Learn from a Smarter Student</option>
        <option value="collaborate">Study Collaboratively</option>
      </select>
      <input type="number" id="smartnessLevel" placeholder="Smartness Level (1-10)" min="1" max="10">
      <select id="genderPreference">
        <option value="any">Any</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
      <button type="submit">Join Gyancho</button>
    </form>
  </div>

  <!-- Main App Screen -->
  <div id="appScreen" class="hidden">
    <nav>
      <button id="reportUserBtn">Report User</button>
      <button id="blockUserBtn">Block User</button>
      <button id="logoutBtn">Leave Gyancho</button>
    </nav>
    <div class="container">
      <h2>Hello, <span id="displayUsername"></span></h2>
      <p>Studying: <span id="displaySubject"></span></p>
      
      <h3>Active Gyancho Users</h3>
      <ul id="userList"></ul>

      <h3>Gyancho Study Session</h3>
      <button id="startSessionBtn">Start Study Session</button>
      <div id="sessionArea" class="hidden">
        <p>Paired with: <span id="partnerName"></span></p>
        <p>Study Mode: <span id="sessionMode"></span></p>
        <textarea id="notes" placeholder="Exchange notes here..."></textarea>
        <button id="sendNoteBtn">Send Note</button>
        <button id="endSessionBtn">End Session</button>
        <div id="livestreamArea" class="hidden">
          <h3>Livestream</h3>
          <video id="localVideo" autoplay muted></video>
          <video id="remoteVideo" autoplay></video>
          <button id="startLivestreamBtn">Start Livestream</button>
          <button id="stopLivestreamBtn" class="hidden">Stop Livestream</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('https://gyancho-1.onrender.com');
    let currentUser = null;
    let users = [];

    // DOM Elements
    const loginScreen = document.getElementById('loginScreen');
    const appScreen = document.getElementById('appScreen');
    const loginForm = document.getElementById('loginForm');
    const displayUsername = document.getElementById('displayUsername');
    const displaySubject = document.getElementById('displaySubject');
    const userList = document.getElementById('userList');
    const startSessionBtn = document.getElementById('startSessionBtn');
    const sessionArea = document.getElementById('sessionArea');
    const partnerNameSpan = document.getElementById('partnerName');
    const sessionModeSpan = document.getElementById('sessionMode');
    const notesTextarea = document.getElementById('notes');
    const sendNoteBtn = document.getElementById('sendNoteBtn');
    const endSessionBtn = document.getElementById('endSessionBtn');
    const reportUserBtn = document.getElementById('reportUserBtn');
    const blockUserBtn = document.getElementById('blockUserBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Login
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      currentUser = {
        username: document.getElementById('username').value,
        subject: document.getElementById('subject').value || 'Not specified',
        studyPreference: document.getElementById('studyPreference').value,
        smartnessLevel: parseInt(document.getElementById('smartnessLevel').value) || 5,
        genderPreference: document.getElementById('genderPreference').value,
        blocked: [],
        reports: []
      };
      socket.emit('new-user', currentUser);
      loginScreen.classList.add('hidden');
      appScreen.classList.remove('hidden');
      displayUsername.textContent = currentUser.username;
      displaySubject.textContent = currentUser.subject;
    });

    // Update user list
    socket.on('update-users', (allUsers) => {
      users = allUsers;
      userList.innerHTML = '';
      users.forEach(user => {
        if (user.username !== currentUser.username && !currentUser.blocked.includes(user.username)) {
          const li = document.createElement('li');
          li.textContent = `${user.username} - ${user.subject} (Level ${user.smartnessLevel})`;
          li.addEventListener('click', () => startSession(user.username));
          userList.appendChild(li);
        }
      });
    });

    // Start session
    function startSession(partnerUsername) {
      socket.emit('start-session', { partnerUsername });
    }

    startSessionBtn.addEventListener('click', () => {
      const partner = users.find(u => u.username !== currentUser.username && !currentUser.blocked.includes(u.username));
      if (partner) startSession(partner.username);
      else alert('No available Gyancho users.');
    });

    // Session started
    socket.on('session-started', ({ partner, mode }) => {
      partnerNameSpan.textContent = partner.username;
      sessionModeSpan.textContent = mode;
      sessionArea.classList.remove('hidden');
      notesTextarea.value = '';
    });

    // Send note
sendNoteBtn.addEventListener('click', () => {
  const note = notesTextarea.value.trim();
  if (note && partnerNameSpan.textContent) {
    socket.emit('send-note', { partnerUsername: partnerNameSpan.textContent, note });
    // Append the new message to the textarea
    const newMessage = `You: ${note}\n`;
    notesTextarea.value += newMessage;
    notesTextarea.scrollTop = notesTextarea.scrollHeight; // Auto-scroll to the bottom
  }
});

    // Receive note
socket.on('receive-note', ({ from, note }) => {
  // Append the received message to the textarea
  const newMessage = `${from}: ${note}\n`;
  notesTextarea.value += newMessage;
  notesTextarea.scrollTop = notesTextarea.scrollHeight; // Auto-scroll to the bottom
});

    // End session
    endSessionBtn.addEventListener('click', () => {
      sessionArea.classList.add('hidden');
    });

    // Report user
    reportUserBtn.addEventListener('click', () => {
      const reportedUsername = prompt('Enter username to report:');
      if (reportedUsername) {
        currentUser.reports.push(reportedUsername);
        socket.emit('report-user', { reportedUsername });
        alert('User reported to Gyancho.');
      }
    });

    // Block user
    blockUserBtn.addEventListener('click', () => {
      const blockedUsername = prompt('Enter username to block:');
      if (blockedUsername) {
        currentUser.blocked.push(blockedUsername);
        socket.emit('block-user', { blockedUsername });
        alert('User blocked on Gyancho.');
      }
    });
// ...existing code...

// Livestream Elements
const livestreamArea = document.getElementById('livestreamArea');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const startLivestreamBtn = document.getElementById('startLivestreamBtn');
const stopLivestreamBtn = document.getElementById('stopLivestreamBtn');

let localStream = null;
let peerConnection = null;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

// Start Livestream
startLivestreamBtn.addEventListener('click', async () => {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;

    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = (event) => {
      remoteVideo.srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        socket.emit('ice-candidate', { candidate: event.candidate });
      }
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('start-livestream', { offer });

    livestreamArea.classList.remove('hidden');
    startLivestreamBtn.classList.add('hidden');
    stopLivestreamBtn.classList.remove('hidden');
  } catch (error) {
    console.error('Error starting livestream:', error);
  }
});

// Stop Livestream
stopLivestreamBtn.addEventListener('click', () => {
  if (peerConnection) peerConnection.close();
  if (localStream) localStream.getTracks().forEach(track => track.stop());

  livestreamArea.classList.add('hidden');
  startLivestreamBtn.classList.remove('hidden');
  stopLivestreamBtn.classList.add('hidden');
  socket.emit('stop-livestream');
});

// Handle Livestream Offer
socket.on('livestream-offer', async ({ offer, from }) => {
  if (!confirm(`${from} wants to start a livestream. Accept?`)) return;

  peerConnection = new RTCPeerConnection(config);
  peerConnection.ontrack = (event) => {
    remoteVideo.srcObject = event.streams[0];
  };

  peerConnection.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit('ice-candidate', { candidate: event.candidate });
    }
  };

  await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;
  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit('livestream-answer', { answer });
  livestreamArea.classList.remove('hidden');
});

// Handle Livestream Answer
socket.on('livestream-answer', async ({ answer }) => {
  await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
});

// Handle ICE Candidate
socket.on('ice-candidate', async ({ candidate }) => {
  try {
    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
  } catch (error) {
    console.error('Error adding received ICE candidate:', error);
  }
});
    // Logout
    logoutBtn.addEventListener('click', () => {
      location.reload();
    });
  </script>
</body>
</html> 